---
title: Improving Service Fabric supportability
date: January, 6th. 2022
summary: The process of increasing the experience and usability of Service Fabric through incremental improvements and customer feedback
tags: Career, Service Fabric
published: True
---

import { ImageGallery } from 'components/post-components/image-gallery';
import { Warning, Li, LiTop, LiBottom, Info } from 'components/post-components';


I have been on the service fabric team for a couple years now, with a primary focus on improving supportability. Supportability can mean a lot of things, so lets narrow it down to the scope of a platform for developers and administrators. While there are more groups who use this product, looking at these users will make it easier to look at why these improvements have been effective. 

While a platform can change depending on context, for this scenario we will call Service Fabric a platform which takes user applications/services and deals with the orchestration part of managing an application. This would include starting the application, balancing the application load, dealing with tolerance to avoid downtime and alerting the user when there are issues. While there are many other things that Service Fabric handles and can do, we are just covering a subset and the features built to support them.

## What is the Goal?

The goal is to reduce the effort required to maintain and increase insights into using a Service Fabric cluster.
The best solution would be the platform's ability to fully handle an issue or fully stop a user from hitting that point.
The second best solution is giving the user everything they need for self mitigation, i.e not needing assistance by using a support case. 

Now until every problem can be handled in one of those two ways, we want to still make the process of investigating and finding relevant information as easy as possible. This would mean surfacing key events at the right time along with reducing the amount of time and effort it takes during an investigation.

### Platform Expectations
We will talk about the following expectations for platform to user interactions, which will be how we decide the effectiveness of a feature.

* A platform's ability to inform users when there is an issue 
* A platform's ability to differentiate when it's a "platform" issue or a "user" issue
* A platform's ability to thoroughly explain an issue and how to resolve it

## Starting Point
A lot of the information we are going to emphasize already exists somewhere but its either cumbersome and difficult to find or its missing useful supporting information. The main reason people used SFX is for when something went wrong, so the goal should always be finding ways to provide more information for investigating.

When I had started improving SFX, it was used for very high level investigations but mainly for the following.

* Is the cluster healthy?
* Finding IDs for different entities
* Viewing health events

While there is other information that was available, a lot of it was "data dumped" into the second page and had no context. This 
information while incredibly useful, required you to fully understand its context and be able to parse it easily.  

Investigations would normally start in SFX but almost always required moving into other tools, in particular one called Trace Viewer. The problem with Trace Viewer is that it is really only accessible to SF engineers and this means people using Service Fabric are lacking a lot of insight. This has two impacts, it makes for a more frustrating experience for people using the platform and it increases the workload on Service Fabric engineers by increasing the potential incident work load.

This situation above is what initially drove  the improvements for SFX by realizing how much more efficient our investigations could become if we exposed some the right information.

### SFX Starting Point
<ImageGallery images={['landing', 'node', 'map', 'metrics', 'application', 'partition', 'replica_details', 'service'].map(image => `/sfx/old_${image}.png`)} ></ImageGallery>

## Informing Users When There Is An Issue
This might sound like an obvious statement but in reality it becomes more of a question of determining how much visibility a given issue needs. 

* Is it transient where maybe it's due to a spike in usage?
* Does this problem if unchecked destroy a cluster? 
* Could something while not be a problem now, become one if something else happens at the same time?

When the objective gets reframed around identifying the most critical issues at a given time it becomes more interesting. For Service Fabric, lets pick a couple of these issues.

* Cluster upgrade status
* Status of nodes in disabling and pending safety checks
* Certificates close to expiring

### Cluster Upgrade Status

<ImageGallery images={['/sfx/upgrade_info.png']}></ImageGallery>

Cluster upgrades can be very impactful for a couple different reasons. They can be changing a major version of be changing a cluster wide config and these changes can cause every node to restarted. When nodes are getting restarted this can trigger safety checks and this causes instances of replicas to be moved. 

Given how much movement can happen during a cluster, it is important to know when one is happening. SFX uses two places to try and inform about the upgrade.

* Banner - While very simple, it can be extremely effective. SFX has two banners, one at the very top that is persisted between pages and one on the landing page. This one is very eye catching because it takes centerfold on the header section and is left intentionally blank otherwise.

* Conditional tile on the landing page - People tend to scan through this page pretty often to get immediate concerns and by moving this to be generally in the middle of the screen, it gives a high chance of them expanding it to view the upgrade.

### Disabling Nodes
When disabling a node to be restarted or removed, all of the services on it must be safely moved to other nodes in the cluster(this is not exactly how it works but it is close enough for this example). We will also cover a very specific health check, which tends to show up very often in incidents.

<Info>
When a node is being disabled, depending on the intent can change what the process of moving replicas. The goal of the safety check is just to ensure that quorum is met before the node is allowed to go down. Depending on the current replica layout, this doesnt mean the a new replica needs to be created and some of these safety checks happen instantly. 

The most common reasons for long running safety checks for an application is that its stuck in error or they have too few nodes up to properly handle a partition configuration, i.e only 4 nodes up but a partition needs 5 replicas.
</Info>

<ImageGallery images={['/sfx/node_deactivation.png']}></ImageGallery>

This information did exist previously but it was not very obvious and unless you had stumbled across it before. This was one of those things which would be "data dumped" onto the second page. Given how impactful a node disabling is, we wanted to pull this information forward.

Step 1 was to make a dedicated area on the essentials page for the node. This tile will only show if there is node is disabled or disabling, this will make sure we are only drawing attention to this when its relevant.

Step 2 is making it easier to understand because even if we just pulled the raw information forward its not easy to follow. The fix is to visualize it to speed up the investigation process. Instead of just listing the partition, its much easier to show the application and service that it belongs to because in large clusters it becomes almost impossible to quickly find the right partition.

### Certificate Expiration
One of the most destructive things that could happen to a cluster is for the cluster certificate to expire. This certficate is used for node to node communication and when that fails, the cluster will collapse. Keeping certificates from expiring is of utmost importance

Similar to the upgrade banner, we went with taking a high visibility spot on the landing page to make it one of the first spots you will see upon visiting. We went with high contrast colors so it stands out.

<Warning>
Banners can be extremely effective but you need to be careful. If you are using banners but they are up a majority of the time, they very quickly lose their effect. They are meant to be used to pull focus when there are items that need to be addressed or high impacting and they should provide information on how to deal with the issue. The criteria we use for a banner is pretty high to try and keep the potential banners relatively low.
</Warning>

<ImageGallery images={['/sfx/cert_banner.png']}></ImageGallery>


## Consistency
This one was really lacking when I originally took up SFX and its something I am pretty happy to have gotten a lot of attention on it.
I started by trying to pull common elements out and making them predictable on the page and improve sizing, starting with health state.

### Essentials Pages
I started by making the health state significantly bigger and always the first item in the list. This is a place where we use the size to indicate importance, its the largest icon on the page and should be the first thing you check. Additionally we always show whether it is stateful or stateless on the second tile and moved to using icons to make it easy to find. This is then followed by health overview for children entities.

Information for tiles will now follow predictable ordering for things like name and status. Information that was previously in the large panels is being split into their own tiles to keep related information together.

<ImageGallery images={['/sfx/service_tiles.png']}></ImageGallery>

### Pending Safety Checks
Safety checks are an opportunity to move an application instance off a node and ensure that the application stays healthy by making new instances on other nodes first. Safety checks are used when some operation needs to be performed on a node like restarting it. Pending safety checks are relevant in two main places currently, upgrades and node deactivations. By reusing the same layouts in both spots, it becomes more clear that these two operations are using the same process and gives the user more insight in how service fabric handles different operations in the same way.

## Visualizations
I believe the most significant addition for improving a platform like Service Fabric is effective visualizations with second place being consistency. Below are what I believe are the most impactful visualizations that have been added to SFX and why there were successful.

### Event Store Viewer
The event store service is great for getting high impact events but it can also be a lot of raw data to parse through and correlate. While these events are useful, they can very quickly become overwhelming. Think of finding the events where a couple machines went down and back up and you are trying to see if they had a pattern.

Given this information is temporal and we are trying to show changes over time, we felt a Gantt chart is most efficient. Next we needed to pick how we wanted to visualize these events, we could directly map them as points and this is half of the solution but we went a step further. We picked a handful of scenarios and the events that would let us chart them as ranges, i.e for an upgrade we are taking the upgrade start and upgrade end and combining them into a time range. This addition made it significantly faster to get a high level idea of what happened for that time range. We then further extended this by combining multiple event stores together so that we can follow patterns across the whole cluster.

<ImageGallery images={['/sfx/eventstore-vIewer.png']}></ImageGallery>

### Repair Jobs
Repair jobs have always played a big role in "Why did this node go down?" and until they had a proper spot in SFX, it was painful to see if they were the culprit. When we decided to start listing them we hit similar issues as the event store viewer; too many repair jobs to easily get a full picture and the solution was to visualize them using the same approach, a Gantt chart. 

Now this helped get a general idea but a repair job has 3 distinct parts; preparing, executing, and restoring. The investigation can be very different depending on if a job is stuck in preparing or executing. We decided we want this broken down in two ways, first by using the same phase diagram that the disabling node's uses and second by creating a graph to show all of these phases relative to each other.

* Phase diagram - This breaks down the job into each part and makes it easy to check how long each part took
<ImageGallery images={['/sfx/expanded_job.png']}></ImageGallery>


* Duration Graph - This graph is very useful for finding outliers and comparing "stuck" jobs to recently completed jobs.

<ImageGallery images={['/sfx/expanded_job.png']}></ImageGallery>


### Upgrade Progress
Given how significant upgrades are, they deserve a clear and concise layout.

<ImageGallery images={['/sfx/upgrade_safety_checks.png']}></ImageGallery>

A cluster upgrade is split into upgrade domains, this is how the upgrade can be safely handled by upgrading a subset of nodes at a time.

The upgrade domain progress is displayed using a pie chart because the amount of upgrade domains can be fairly variable and we wanted a fix size for consistent layout. This is because generally people are just looking at it for overall progress and a pie chart is size agnostic in that regard; i.e 50% of the way is the same appearance for 4 or 20 upgrade domains.

The nodes for the current domain being upgraded use the phase diagram because like the repair job and disabling node, we are trying to represent a state machine. By reusing this same layout it makes people more familiar with what is a state machine at a glance.

Upgrades can timeout and its useful to know how close you are to a timeout rollback, this is why we went with progress bars for the overall upgrade and the current upgrade domain. Colored progress bars are the fastest way to make it clear how much time is left.

## Wrapping up
<ImageGallery images={['landing', 'node', 'map', 'metrics', 'application', 'partition', 'service'].map(image => `/sfx/new_${image}.png`)} ></ImageGallery>

By using these layout tools and design choices, we have been able to take SFX and make it a much more powerful starting point for investigation. A lot of these improvements have driven reductions in incident volume and faster time to mitigation.

