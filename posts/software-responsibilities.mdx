---
title: Improving Service Fabric supportability
date: January, 6th. 2022
summary: The process of increasing the experience and usability of Service Fabric through incremental improvements and customer feedback
tags: Career, Service Fabric
---

import { ImageGallery } from 'components/post-components/image-gallery';
import { Warning, Li, LiTop, LiBottom } from 'components/post-components';


I have been on the service fabric team for a couple years now, with a primary focus on improving supportability. Supportability can mean a lot of things, so lets narrow it down to the scope of a platform for developers/administrators. While there are more groups who use this product, looking at these users will make it easier to look at why these improvements have been effective. 

While a platform can change depending on context, for this scenario we will call Service Fabric a platform which takes user applications/services and deals with the orchestration part of managing an application. This would include starting the application, balancing the application load, dealing with tolerance to avoid downtime and alerting the user when there are issues. While there are many other things that Service Fabric handles and can do, we are just covering a subset and the features built to support them.

## What is the Goal?

The goal is to reduce the effort required to maintain and increase insights into using a Service Fabric cluster.
The best solution would be the platform's ability to fully handle an issue or fully stop a user from hitting that point.
The second best solution is giving the user everything they need for self mitigation, i.e not needing assistance by using a support case. 

Now until every problem can be handled in one of those two ways, we want to still make the process of investigating and finding relevant information as easy as possible. This would still mean surfacing key events at the right time and reducing the amount of time and effort it takes during an investigation.

### Platform expectations
We will talk about the following expectations for platform to user interactions, which will be the basis for deciding how effective a feature is.

* A platform's ability to inform users when there is an issue 
* A platform's ability to differentiate when it's a "platform" issue or a "user" issue
* A platform's ability to thoroughly explain an issue and how to resolve it


## Starting Point
A lot of the information we are going to emphasize, already exists somewhere but its either cumbersome and difficult to find or its missing useful supporting information. The main reason people use SFX is for when something went wrong, so the goal should always be finding ways to provide more information for investigating.

When I had started improving SFX, it was used for very high level investigations but mainly for the following.

* Is the cluster healthy?
* Finding IDs for different entities
* Viewing health events

While there is other information that was available, a lot of it was "data dumped" into the second page and had no context. This 
information while incredibly useful, required you to fully understand its context and be able to parse it easily.  

Investigations would normally start in SFX but almost always required moving into other tools, in particular one called Trace Viewer. The problem with Trace Viewer is that it is really only accessible to SF engineers and this means people using Service Fabric are lacking a lot of insight. This has two impacts, it makes for a more frustrating experience for people using the platform and it increases the workload on Service Fabric engineers by increasing the potential incident work load.

This situation above is what initially drove  the improvements for SFX by realizing how much more efficient our investigations could become if we exposed some the right information.

### SFX Starting Point
<ImageGallery images={['landing', 'node', 'map', 'metrics', 'application', 'partition', 'replica_details', 'service'].map(image => `/sfx/old_${image}.png`)} ></ImageGallery>

## Informing users when there is an issue
This might sound like an obvious statement but in reality it becomes more of a question of determining how much visibility a given issue needs. 

* Is it transient where maybe it's due to a spike in usage?
* Does this problem if unchecked destroy a cluster? 
* Could something while not be a problem now, become one if something else happens at the same time?

When the objective gets reframed around identifying the most critical issues at a given time it becomes more interesting. For Service Fabric, lets pick a couple of these issues.

* Cluster upgrade status
* Status of nodes in disabling and pending safety checks
* Certificates close to expiring

### Cluster Upgrade Status

<ImageGallery images={['/sfx/upgrade_info.png']}></ImageGallery>

Cluster upgrades can be very impactful for a couple different reasons. They can be changing a major version of be changing a cluster wide config and these changes can cause every node to restarted. When nodes are getting restarted this can trigger safety checks and this causes instances of replicas to be moved. 

Given how much movement can happen during a cluster, it is important to know when one is happening. SFX uses two places to try and inform about the upgrade.

* Banner - While very simple, it can be extremely effective. SFX has two banners, one at the very top that is persisted between pages and one on the landing page. This one is very eye catching because it takes centerfold on the header section and is left intentionally blank otherwise.

* Conditional tile on the landing page - People tend to scan through this page pretty often to get immediate concerns and by moving this to be generally in the middle of the screen, it gives a high chance of them expanding it to view the upgrade.

### Disabling Nodes
When disabling a node to be restarted or "removed", all of the services on it must be safely moved to other nodes in the cluster(this is not exactly how it works but it is close enough for this example).

<Warning>
### Dont make your own authentication system
Use a well tested existing solution. Unless you are very well versed in security, you should never roll your own authentication solution which will hold a real personâ€™s data. 
</Warning>

<ImageGallery images={['/sfx/node_deactivation.png']}></ImageGallery>


This was an item where the information did technically exist but it was relatively hidden and only people who learned where to find it would know and thats assuming they knew how the process worked. The goal here was two parts, make it very obvious that is disabling and make it clear what the state is. 

Step 1 make a dedicated area on the essentials page for the node, this will get people familiar to knowing quickly by seeing if the panel is there. 

Step 2 is making it easier to understand, even if we just pulled the raw information forward its not easy to follow. The fix for this is to visualize it and speed up the investigation process. Instead of just listing the partition, its much easier to show the application and service that it belongs to because in large clusters it becomes almost impossible to quickly find the right partition. I will talk more to visualizations and why I think they're so significant further down. 

### Certificate Expiration
Similar to the 

<ImageGallery images={['/sfx/cert_banner.png']}></ImageGallery>


## Consistency
This one was really lacking when I originally took up SFX and its something I am pretty happy to have gotten much more standard.
I started by trying to pull common elements out and making them predictable for where you'd expect them and improve sizing, starting with health state.

### Essentials Pages
I made the health state significantly bigger and always the first item in the list, this is a place where we use the size to indicate importance. Additionally we always show whether it is stateful or stateless on the second tile and moved to using icons to make it easy to find. This is then followed by health overview for children entities.

Information for tiles will now follow predictable ordering for things like name and status. Information that was previously in the large panels is being split into their own tiles to keep related information together.

<ImageGallery images={['/sfx/service_tiles.png']}></ImageGallery>

### Pending Safety checks
Safety checks are an opportunity to safely move an application instance on node off, these are used when some operation needs to be performed on a node. Pending safety checks are relevant in two main places currently, upgrades and node deactivations. The goal of always showing safety checks using the same information will reinforce that its the same process regardless of what initiated the operation.


## Visualizations
I believe the most significant addition for improving a platform like Service Fabric is well done and appropriate visualizations, with second place being consistency. I am going to cover what I believe are the most impactful visualizations that have been added to SFX.

### Event Store Viewer
The event store service is great for getting high impact events but it can also be a lot of raw data to parse through and correlate. While these events are useful, they can very quickly become overwhelming and difficult to parse, Think of finding the event where a couple machines went down and back up and you are trying to see if had a pattern. This Visualizations given it is time based, was best suited for a Gantt chart. The way we approached this was by identifying the most useful scenarios and finding which events we need to chart it. For example a cluster upgrade would have a start and finish event, along with events for each domain. This addition made it significantly faster to get a high level idea of what happened for that time range and later on we started combining multiple types of events into one timeline so we could compare. 

<ImageGallery images={['/sfx/eventstore-vIewer.png']}></ImageGallery>


### Repair Jobs
Repair jobs have always played a big role in "Why did this node or nodes go down?" and until they had a proper spot in SFX, it was painful to see and parse them. When we decided to start listing them we hit similar issues as the event store viewer; too many repair jobs to easily get a full picture and the solution was to visualize them using the same approach, a Gantt chart. 
Now this helped get a general idea but a repair job has 3 distinct parts; preparing, executing, and restoring. The investigation can be very different depending on if a job is stuck in preparing or executing. I decided we want this broken down in two ways, first by using the same phase diagram that the disabling node's uses and second by creating a graph to show all of these phases relative to each other.

* Phase diagram - This breaks down the job into each part and makes it easy to check how long each part took
<ImageGallery images={['/sfx/expanded_job.png']}></ImageGallery>


* Duration Graph - This graph is very useful for finding outliers and comparing "stuck" jobs to recently completed jobs.

<ImageGallery images={['/sfx/expanded_job.png']}></ImageGallery>


### Upgrade Progress
Given how significant upgrades are, they deserve a well layed out and clear representation.

<ImageGallery images={['/sfx/upgrade_safety_checks.png']}></ImageGallery>

The upgrade domain progress is displayed using a pie chart because the amount of upgrade domains can be fairly variable, so we wanted to use something with a fixed size. This is because generally people are just looking at it for overall progress and a pie chart is size agnostic in that regard; i.e 50% of the way is the same appearance for 4 or 20 upgrade domains.

The nodes for the current domain being upgraded use the phase diagram because like the repair job and disabling node, we are trying to represent a state machine. By reusing this same layout, it makes it very easy for people to become familiar with the process and it keeps consistency.

Upgrades can timeout and its really good to know how close you are to it happening, this is why we went with progress bars for the overall upgrade and the current upgrade domain. Colored progress bars are the fastest way to make it clear how much time is left.

## Wrapping up

<ImageGallery images={['landing', 'node', 'map', 'metrics', 'application', 'partition', 'service'].map(image => `/sfx/new_${image}.png`)} ></ImageGallery>
